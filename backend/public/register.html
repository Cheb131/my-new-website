 <!DOCTYPE html>
 <html lang="vi">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gia nhập Hội Quán Mạo Hiểm</title>
   <style>
    :root {
      --bg-night: #1a1426;
      --bg-night-2: #241734;
      --parchment: #f3e6c8;
      --parchment-deep: #dbc392;
      --ink: #2d1f12;
      --accent-gold: #d7b56d;
      --accent-crimson: #7a1f2b;
      --success: #1f7a51;
      --danger: #8b2435;
     }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:
        radial-gradient(circle at 10% 20%, rgba(215, 181, 109, 0.16), transparent 40%),
        radial-gradient(circle at 85% 0%, rgba(122, 31, 43, 0.22), transparent 35%),
        linear-gradient(160deg, var(--bg-night) 0%, var(--bg-night-2) 100%);
      color: var(--ink);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px 16px;
     }

    .wrap {
      width: min(560px, 100%);
      background: linear-gradient(170deg, #f8edd2, var(--parchment));
      border: 2px solid rgba(215, 181, 109, 0.8);
      border-radius: 16px;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.35);
      overflow: hidden;
     }

    .card-head {
      padding: 18px 20px;
      background: linear-gradient(145deg, #3f284f, #2b1a38);
      color: #f5e8c6;
      border-bottom: 2px solid rgba(215, 181, 109, 0.5);
     }

    .title {
      margin: 0;
      font-size: 20px;
       text-transform: uppercase;
      letter-spacing: 0.6px;
      font-family: Georgia, "Times New Roman", serif;
     }

    .subtitle {
      margin: 8px 0 0;
       font-size: 13px;
      opacity: 0.95;
     }

    form {
       padding: 18px;
       display: grid;
       gap: 12px;
     }

    label {
       font-size: 13px;
       font-weight: 700;
      display: block;
       margin-bottom: 6px;
      color: #523823;
     }

    .field input {
      width: 100%;
       height: 42px;
       border-radius: 10px;
      border: 1px solid #b99a62;
      background: #fff7e6;
      padding: 0 12px;
      color: var(--ink);
       outline: none;
     }

    .field input:focus {
      border-color: var(--accent-crimson);
      box-shadow: 0 0 0 3px rgba(122, 31, 43, 0.15);
     }

    .hint {
       margin-top: 6px;
      font-size: 12px;
      color: #76512f;
       line-height: 1.35;
     }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
     }

    .error, .success {
      display: none;
       border-radius: 10px;
      padding: 10px 12px;
       font-size: 13px;
       line-height: 1.35;
     }

    .error {
      background: #fde7ea;
      border: 1px solid #efbac2;
      color: var(--danger);
    }

    .success {
      background: #e6f8ef;
      border: 1px solid #9fd7bb;
      color: var(--success);
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 2px;
     }

    .btn {
       height: 42px;
       border-radius: 10px;
      border: 1px solid transparent;
       font-weight: 800;
      cursor: pointer;
       text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
       flex: 1;
     }

    .btn-primary {
      background: linear-gradient(140deg, var(--accent-crimson), #5e1822);
      color: #fff8eb;
      border-color: rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: #f7edd7;
      color: #3d2a1a;
      border-color: #d9bf8a;
     }

    @media (max-width: 560px) {
      .row { grid-template-columns: 1fr; }
     }
   </style>
 </head>
 
 <body>
   <div class="wrap">
    <div class="card-head">
      <h1 class="title">Gia nhập Hội Quán Mạo Hiểm</h1>
      <p class="subtitle">Tạo hồ sơ tân binh để bắt đầu chiến dịch tại DnD Guild Chronicle.</p>
    </div>
 
    <form id="registerForm" novalidate>
      <div class="error" id="formError"></div>
      <div class="success" id="formSuccess"></div>
 
      <div class="field">
        <label for="username">Bí danh mạo hiểm</label>
        <input id="username" name="username" type="text" placeholder="vd: ranger_viet" autocomplete="username" required />
        <div class="hint">4–20 ký tự, chỉ dùng chữ/số/dấu gạch dưới (_).</div>
      </div>
 
      <div class="row">
         <div class="field">
          <label for="password">Mật ngữ</label>
          <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="new-password" required />
          <div class="hint">Tối thiểu 6 ký tự.</div>
         </div>
 
         <div class="field">
          <label for="password2">Xác nhận mật ngữ</label>
          <input id="password2" name="password2" type="password" placeholder="••••••••" autocomplete="new-password" required />
         </div>
      </div>
 
      <div class="field">
        <label for="email">Thư ma pháp (Email)</label>
        <input id="email" name="email" type="email" placeholder="vd: hero@gmail.com" autocomplete="email" required />
      </div>

      <div class="field">
        <label for="phone">Liên lạc hội nhóm</label>
        <input id="phone" name="phone" type="tel" placeholder="vd: 0901234567" autocomplete="tel" required />
        <div class="hint">Chỉ nhập số, 10–11 ký tự.</div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">Tạo hồ sơ tân binh</button>
        <a class="btn btn-secondary" href="index.html">Về đại sảnh</a>
      </div>
    </form>
   </div>
 
  <script>
    const API_BASE = (location.port === "5500") ? "http://localhost:3000" : "";

    const form = document.getElementById("registerForm");
    const errBox = document.getElementById("formError");
    const okBox = document.getElementById("formSuccess");

    function showError(msg) {
      okBox.style.display = "none";
      okBox.textContent = "";
      errBox.textContent = msg;
      errBox.style.display = "block";
    }

    function showSuccess(msg) {
      errBox.style.display = "none";
      errBox.textContent = "";
      okBox.textContent = msg;
      okBox.style.display = "block";
     }
 
    function normalizeError(data) {
      if (!data) return "Đăng ký thất bại.";
      if (data.message) return data.message;

      const fieldErrors = data?.errors?.fieldErrors;
      if (fieldErrors && typeof fieldErrors === "object") {
        const first = Object.values(fieldErrors).find((arr) => Array.isArray(arr) && arr.length);
        if (first?.length) return first[0];
      }
      return "Dữ liệu không hợp lệ.";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const password2 = document.getElementById("password2").value;
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (username.length < 4 || username.length > 20) {
        showError("Bí danh phải từ 4 đến 20 ký tự.");
        return;
      }

      if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        showError("Bí danh chỉ được dùng chữ/số/dấu gạch dưới (_).");
        return;
      }

      if (password.length < 6) {
        showError("Mật ngữ tối thiểu 6 ký tự.");
        return;
      }

      if (password !== password2) {
        showError("Mật ngữ xác nhận chưa khớp.");
        return;
      }

      if (!/^\S+@\S+\.\S+$/.test(email)) {
        showError("Email chưa đúng định dạng.");
        return;
      }

      if (!/^[0-9]{10,11}$/.test(phone)) {
        showError("Liên lạc hội nhóm phải gồm 10–11 chữ số.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, email, phone }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showError(normalizeError(data));
          return;
        }

        showSuccess("Gia nhập hội quán thành công! Đang chuyển bạn đến đại sảnh...");
        form.reset();
 
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1200);
      } catch (err) {
        console.error(err);
        showError("Không kết nối được tới cổng đăng ký.");
      }
    });
  </script>
 </body>
 </html>
