<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Danh s√°ch nh√¢n v·∫≠t ‚Äî H·ªôi Qu√°n Dungeons & Dragons</title>

  <meta name="description" content="Danh s√°ch nh√¢n v·∫≠t ƒë∆∞·ª£c ƒëƒÉng l√™n web." />
  <meta name="robots" content="index, follow" />

  <link rel="stylesheet" href="/CSS/style.css">

  <style>
    .charlist-page { padding: 18px 0 28px; }
    .charlist-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .charlist-head h2{ margin:0; font-size: 20px; }
    .charlist-sub{ margin:6px 0 0; color:#6b7280; font-size: 14px; }
    .charlist-tools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .cc-btn{
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .cc-btn:hover{ background:#f9fafb; }

    .char-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }
    .char-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .char-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    .char-card-top{
      display:grid;
      grid-template-columns: 88px 1fr;
      gap: 12px;
      padding: 12px;
      align-items:center;
    }
    .char-avatar{
      width: 88px;
      height: 88px;
      border-radius: 14px;
      object-fit: cover;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
    }
    .char-title{ margin:0 0 4px; font-size: 16px; line-height: 1.2; }
    .char-meta{ margin:0; color:#6b7280; font-size: 13px; line-height: 1.35; }
    .char-desc{
      margin:0;
      color:#374151;
      font-size: 13px;
      line-height: 1.45;
      padding: 0 12px 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .char-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 0 12px 12px;
    }
    .char-tag{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      font-size: 12px;
      color:#374151;
    }

    .empty-box{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      color:#6b7280;
    }

    @media (max-width: 1100px){
      .char-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 700px){
      .char-grid{ grid-template-columns: 1fr; }
    }
    .char-card{ position:relative; }

    .char-del{
      position:absolute;
      top:10px;
      right:10px;
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-size:16px;
      display:flex;align-items:center;justify-content:center;
    }
    .char-del:hover{ background:#fee2e2; border-color:#fecaca; }

  </style>
</head>

<body>
  <!-- ===== LOGIN MODAL (gi·ªëng index) ===== -->
  <div class="login-modal" id="loginModal" hidden>
    <div class="login-box">
      <h3>ƒêƒÉng nh·∫≠p</h3>
      <div id="loginError" style="display:none;color:#b91c1c;font-size:13px;margin:6px 0 10px;"></div>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required />
        <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required />
        <button type="submit">ƒêƒÉng nh·∫≠p</button>
      </form>
      <button class="login-close" id="loginClose" type="button" aria-label="ƒê√≥ng">‚úï</button>
    </div>
  </div>

  <!-- ===== HEADER (gi·ªëng index) ===== -->
  <header class="site-header">
    <div class="header-banner">
      <img src="/Assets/images/background.jpg" alt="Banner" class="banner-bg" />
      <div class="banner-inner container">
        <div class="logo-group left">
          <button class="menu-toggle" id="mnavToggle" type="button" aria-label="M·ªü menu">
            <img src="Assets/icons/menu.png" alt="">
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== NAV (gi·ªëng index) ===== -->
  <nav class="main-nav" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <div class="container">
      <ul class="nav-list">
        <li><a href="index.html">Trang ch·ªß</a></li>

        <li class="has-dropdown">
          <a href="list.html">Nhi·ªám v·ª• & S·ª± ki·ªán</a>
          <ul class="dropdown">
            <li><a href="#">Nhi·ªám v·ª• m·ªõi</a></li>
            <li><a href="#">S·ª± ki·ªán guild</a></li>
            <li><a href="#">Th√¥ng c√°o t·ª´ h·ªôi qu√°n</a></li>
          </ul>
        </li>

        <li class="has-dropdown active">
          <a href="character-list.html">S·ªï tay hu·∫•n luy·ªán</a>
          <ul class="dropdown">
            <li><a href="character-list.html">Danh s√°ch nh√¢n v·∫≠t</a></li>
            <li><a href="character.html">Trang nh√¢n v·∫≠t</a></li>
          </ul>
        </li>

        <li class="has-dropdown">
          <a href="#">Kho t∆∞ li·ªáu c·ªï th∆∞</a>
          <ul class="dropdown">
            <li><a href="#">B√°ch khoa qu√°i v·∫≠t</a></li>
            <li><a href="#">B·∫£n ƒë·ªì l·ª•c ƒë·ªãa</a></li>
            <li><a href="#">Lu·∫≠t ch∆°i t√¢n th·ªß</a></li>
            <li><a href="#">H∆∞·ªõng d·∫´n DM</a></li>
          </ul>
        </li>

        <li class="has-dropdown">
          <a href="#">Kho h·ªçc c·ª•</a>
          <ul class="dropdown">
            <li><a href="https://stbook.vn/">Th∆∞ vi·ªán ph√©p thu·∫≠t</a></li>
            <li><a href="#">T√†i nguy√™n chi·∫øn d·ªãch</a></li>
          </ul>
        </li>

        <!-- USER (gi·ªëng index) -->
        <li class="nav-user has-dropdown" id="navUserBox">
          <button id="userToggleBtn" type="button" class="nav-user-toggle" aria-label="T√†i kho·∫£n">
            <span class="nav-user-ico">
              <img src="Assets/icons/account.png" alt="">
            </span>
            <span id="userName" class="nav-user-name" hidden></span>
            <span class="nav-user-caret">‚ñæ</span>
          </button>
          <ul class="dropdown user-dropdown" id="userDropdown"></ul>
        </li>

        <!-- ‚úÖ CH·ªà GI·ªÆ SEARCH TR√äN NAV -->
        <li class="nav-search">
          <form class="search" action="character-list.html" method="get" role="search">
            <input
              type="search"
              name="q"
              id="navSearchInput"
              class="search__input"
              placeholder="T√¨m nh√¢n v·∫≠t..."
              aria-label="T√¨m ki·∫øm"
              maxlength="80"
            />
            <div class="search-results" hidden></div>
            <button class="search__btn" type="submit" aria-label="T√¨m">
              <img src="Assets/icons/search.png" alt="">
            </button>
          </form>
        </li>

      </ul>
    </div>
  </nav>

  <div class="page-wrap">
    <main class="main-content">
      <section class="charlist-page">
        <div class="container">
          <div class="charlist-head">
            <div>
              <h2>Danh s√°ch nh√¢n v·∫≠t</h2>
              <p class="charlist-sub" id="charCount">ƒêang t·∫£i...</p>
            </div>

            <div class="charlist-tools">
              <button class="cc-btn" type="button" id="reloadBtn">‚Üª T·∫£i l·∫°i</button>
              <button class="cc-btn" type="button" id="goCreateBtn"
                onclick="window.location.href='character-create.html'">
                + T·∫°o/ƒêƒÉng nh√¢n v·∫≠t
              </button>
            </div>
          </div>

          <div id="listBox"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== FOOTER (gi·ªëng index) ===== -->
  <footer class="site-footer">
    <div class="container footer-top">
      <div class="footer-info">
        <p class="footer-title">¬© H·ªòI QU√ÅN DUNGEONS & DRAGONS VI·ªÜT NAM</p>
        <p>ƒê·ªãa ch·ªâ: Ph√≤ng h·ªôi t·∫ßng h·∫ßm - Th√†nh Greyhawk</p>
        <p>Li√™n l·∫°c: +84 999 20D20</p>
        <p>Email: guildmaster@dnd-vietnam.vn</p>
      </div>
    </div>
  </footer>

  <script src="/JS/menu.js"></script>
  <script src="/JS/core.js"></script>

  <script>
   (function () {
  const listBox = document.getElementById("listBox");
  const reloadBtn = document.getElementById("reloadBtn");
  const countEl = document.getElementById("charCount");
  const navSearchInput = document.getElementById("navSearchInput");

  let all = [];

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function getQuery() {
    const q = new URLSearchParams(location.search).get("q");
    return (q || "").trim().toLowerCase();
  }

  function cardHtml(c) {
    const id = Number(c.id);
    const name = esc(c.name || "Unknown");
    const race = esc(c.race || "‚Äî");
    const cls  = esc(c.class_name || "‚Äî");
    const lv   = Number(c.level || 1);
    const desc = esc(c.description || "");
    const avatar = (c.avatar && String(c.avatar).trim()) ? c.avatar : "/Assets/images/sample.png";

    return `
      <article class="char-card" role="button" tabindex="0" data-id="${id}">
        <button class="char-del" type="button" data-del="${id}" title="Xo√° nh√¢n v·∫≠t">üóëÔ∏è</button>

        <div class="char-card-top">
          <img class="char-avatar" src="${esc(avatar)}" alt="${name}">
          <div>
            <h3 class="char-title">${name}</h3>
            <p class="char-meta">${race} ‚Ä¢ ${cls} ‚Ä¢ Lv ${lv}</p>
          </div>
        </div>

        <p class="char-desc">${desc || "‚Äî"}</p>

        <div class="char-tags">
          <span class="char-tag">HP: ${Number(c.hp ?? 10)}</span>
          <span class="char-tag">AC: ${Number(c.ac ?? 10)}</span>
          <span class="char-tag">Speed: ${esc(c.speed || "30 ft")}</span>
        </div>
      </article>
    `;
  }

  function render(list, totalAll) {
    if (!Array.isArray(list) || list.length === 0) {
      listBox.innerHTML = `
        <div class="empty-box">
          Kh√¥ng c√≥ nh√¢n v·∫≠t ph√π h·ª£p. H√£y th·ª≠ t√¨m t·ª´ kho√° kh√°c ho·∫∑c t·∫°o nh√¢n v·∫≠t m·ªõi.
        </div>
      `;
      countEl.textContent = totalAll != null ? `0/${totalAll} nh√¢n v·∫≠t` : "0 nh√¢n v·∫≠t";
      return;
    }

    listBox.innerHTML = `<div class="char-grid">${list.map(cardHtml).join("")}</div>`;

    // Click card -> v√†o trang chi ti·∫øt (tr·ª´ khi click n√∫t xo√°)
    listBox.querySelectorAll(".char-card").forEach((card) => {
      const go = () => {
        const id = card.getAttribute("data-id");
        window.location.href = `character.html?id=${encodeURIComponent(id)}`;
      };

      card.addEventListener("click", (e) => {
        // n·∫øu b·∫•m v√†o n√∫t xo√° th√¨ kh√¥ng ƒëi trang detail
        if (e.target.closest?.("[data-del]")) return;
        go();
      });

      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter") go();
      });
    });
  }

  function applyFilter() {
    const q = getQuery();
    if (navSearchInput) navSearchInput.value = q ? q : "";

    if (!q) {
      render(all, all.length);
      countEl.textContent = `${all.length} nh√¢n v·∫≠t`;
      return;
    }

    const filtered = all.filter((c) => {
      const s = [
        c.name, c.race, c.class_name, c.alignment, c.background, c.description
      ].join(" ").toLowerCase();
      return s.includes(q);
    });

    render(filtered, all.length);
    countEl.textContent = `${filtered.length}/${all.length} nh√¢n v·∫≠t`;
  }

  async function load() {
    listBox.innerHTML = `<div class="empty-box">ƒêang t·∫£i danh s√°ch nh√¢n v·∫≠t...</div>`;
    countEl.textContent = "ƒêang t·∫£i...";

    try {
      const res = await fetch("/api/characters/public");
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        listBox.innerHTML = `<div class="empty-box">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch (server tr·∫£ l·ªói).</div>`;
        countEl.textContent = "L·ªói t·∫£i";
        return;
      }

      all = Array.isArray(data) ? data : [];
      all.sort((a,b) => Number(b.id || 0) - Number(a.id || 0));

      applyFilter();
    } catch (e) {
      listBox.innerHTML = `<div class="empty-box">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server.</div>`;
      countEl.textContent = "L·ªói k·∫øt n·ªëi";
    }
  }

  // ‚úÖ Xo√° nh√¢n v·∫≠t (event delegation)
  listBox.addEventListener("click", async (e) => {
    const btn = e.target.closest?.("[data-del]");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const id = btn.getAttribute("data-del");
    if (!id) return;

    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° nh√¢n v·∫≠t n√†y kh√¥ng?")) return;

    try {
      const res = await fetch(`/api/characters/${encodeURIComponent(id)}`, {
        method: "DELETE",
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(data?.message || "Xo√° th·∫•t b·∫°i");
        return;
      }

      await load();
    } catch (err) {
      alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server");
    }
  });

  reloadBtn.addEventListener("click", load);

  // Khi back/forward thay ƒë·ªïi ?q=, t·ª± filter l·∫°i
  window.addEventListener("popstate", applyFilter);

  load();
})();

  </script>
</body>
</html>
